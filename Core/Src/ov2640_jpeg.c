/*
 * ov2640_jpeg.c
 *
 *  Created on: Aug 17, 2024
 *      Author: user
 */

#include "ov2640_jpeg.h"
#include "i2c.h"
#include "usart.h"
#include "dcmi.h"
#include <string.h>
#include <stdio.h>

uint8_t pictureBuff[JPEG_BUFF_SIZE];

uint8_t uart_message[256];
uint32_t uart_size;

const unsigned char OV2640_JPEG_INIT[][2] =
{
{ 0xff, 0x00 },
{ 0x2c, 0xff },
{ 0x2e, 0xdf },
{ 0xff, 0x01 },
{ 0x3c, 0x32 },
{ 0x11, 0x00 },
{ 0x09, 0x02 },
{ 0x04, 0x28 },
{ 0x13, 0xe5 },
{ 0x14, 0x48 },
{ 0x2c, 0x0c },
{ 0x33, 0x78 },
{ 0x3a, 0x33 },
{ 0x3b, 0xfB },
{ 0x3e, 0x00 },
{ 0x43, 0x11 },
{ 0x16, 0x10 },
{ 0x39, 0x92 },
{ 0x35, 0xda },
{ 0x22, 0x1a },
{ 0x37, 0xc3 },
{ 0x23, 0x00 },
{ 0x34, 0xc0 },
{ 0x36, 0x1a },
{ 0x06, 0x88 },
{ 0x07, 0xc0 },
{ 0x0d, 0x87 },
{ 0x0e, 0x41 },
{ 0x4c, 0x00 },
{ 0x48, 0x00 },
{ 0x5B, 0x00 },
{ 0x42, 0x03 },
{ 0x4a, 0x81 },
{ 0x21, 0x99 },
{ 0x24, 0x40 },
{ 0x25, 0x38 },
{ 0x26, 0x82 },
{ 0x5c, 0x00 },
{ 0x63, 0x00 },
{ 0x61, 0x70 },
{ 0x62, 0x80 },
{ 0x7c, 0x05 },
{ 0x20, 0x80 },
{ 0x28, 0x30 },
{ 0x6c, 0x00 },
{ 0x6d, 0x80 },
{ 0x6e, 0x00 },
{ 0x70, 0x02 },
{ 0x71, 0x94 },
{ 0x73, 0xc1 },
{ 0x12, 0x40 },
{ 0x17, 0x11 },
{ 0x18, 0x43 },
{ 0x19, 0x00 },
{ 0x1a, 0x4b },
{ 0x32, 0x09 },
{ 0x37, 0xc0 },
{ 0x4f, 0x60 },
{ 0x50, 0xa8 },
{ 0x6d, 0x00 },
{ 0x3d, 0x38 },
{ 0x46, 0x3f },
{ 0x4f, 0x60 },
{ 0x0c, 0x3c },
{ 0xff, 0x00 },
{ 0xe5, 0x7f },
{ 0xf9, 0xc0 },
{ 0x41, 0x24 },
{ 0xe0, 0x14 },
{ 0x76, 0xff },
{ 0x33, 0xa0 },
{ 0x42, 0x20 },
{ 0x43, 0x18 },
{ 0x4c, 0x00 },
{ 0x87, 0xd5 },
{ 0x88, 0x3f },
{ 0xd7, 0x03 },
{ 0xd9, 0x10 },
{ 0xd3, 0x82 },
{ 0xc8, 0x08 },
{ 0xc9, 0x80 },
{ 0x7c, 0x00 },
{ 0x7d, 0x00 },
{ 0x7c, 0x03 },
{ 0x7d, 0x48 },
{ 0x7d, 0x48 },
{ 0x7c, 0x08 },
{ 0x7d, 0x20 },
{ 0x7d, 0x10 },
{ 0x7d, 0x0e },
{ 0x90, 0x00 },
{ 0x91, 0x0e },
{ 0x91, 0x1a },
{ 0x91, 0x31 },
{ 0x91, 0x5a },
{ 0x91, 0x69 },
{ 0x91, 0x75 },
{ 0x91, 0x7e },
{ 0x91, 0x88 },
{ 0x91, 0x8f },
{ 0x91, 0x96 },
{ 0x91, 0xa3 },
{ 0x91, 0xaf },
{ 0x91, 0xc4 },
{ 0x91, 0xd7 },
{ 0x91, 0xe8 },
{ 0x91, 0x20 },
{ 0x92, 0x00 },
{ 0x93, 0x06 },
{ 0x93, 0xe3 },
{ 0x93, 0x05 },
{ 0x93, 0x05 },
{ 0x93, 0x00 },
{ 0x93, 0x04 },
{ 0x93, 0x00 },
{ 0x93, 0x00 },
{ 0x93, 0x00 },
{ 0x93, 0x00 },
{ 0x93, 0x00 },
{ 0x93, 0x00 },
{ 0x93, 0x00 },
{ 0x96, 0x00 },
{ 0x97, 0x08 },
{ 0x97, 0x19 },
{ 0x97, 0x02 },
{ 0x97, 0x0c },
{ 0x97, 0x24 },
{ 0x97, 0x30 },
{ 0x97, 0x28 },
{ 0x97, 0x26 },
{ 0x97, 0x02 },
{ 0x97, 0x98 },
{ 0x97, 0x80 },
{ 0x97, 0x00 },
{ 0x97, 0x00 },
{ 0xc3, 0xed },
{ 0xa4, 0x00 },
{ 0xa8, 0x00 },
{ 0xc5, 0x11 },
{ 0xc6, 0x51 },
{ 0xbf, 0x80 },
{ 0xc7, 0x10 },
{ 0xb6, 0x66 },
{ 0xb8, 0xA5 },
{ 0xb7, 0x64 },
{ 0xb9, 0x7C },
{ 0xb3, 0xaf },
{ 0xb4, 0x97 },
{ 0xb5, 0xFF },
{ 0xb0, 0xC5 },
{ 0xb1, 0x94 },
{ 0xb2, 0x0f },
{ 0xc4, 0x5c },
{ 0xc0, 0x64 },
{ 0xc1, 0x4B },
{ 0x8c, 0x00 },
{ 0x86, 0x3D },
{ 0x50, 0x00 },
{ 0x51, 0xC8 },
{ 0x52, 0x96 },
{ 0x53, 0x00 },
{ 0x54, 0x00 },
{ 0x55, 0x00 },
{ 0x5a, 0xC8 },
{ 0x5b, 0x96 },
{ 0x5c, 0x00 },
{ 0xd3, 0x00 },
{ 0xc3, 0xed },
{ 0x7f, 0x00 },
{ 0xda, 0x00 },
{ 0xe5, 0x1f },
{ 0xe1, 0x67 },
{ 0xe0, 0x00 },
{ 0xdd, 0x7f },
{ 0x05, 0x00 },
{ 0x12, 0x40 },
{ 0xd3, 0x04 },
{ 0xc0, 0x16 },
{ 0xC1, 0x12 },
{ 0x8c, 0x00 },
{ 0x86, 0x3d },
{ 0x50, 0x00 },
{ 0x51, 0x2C },
{ 0x52, 0x24 },
{ 0x53, 0x00 },
{ 0x54, 0x00 },
{ 0x55, 0x00 },
{ 0x5A, 0x2c },
{ 0x5b, 0x24 },
{ 0x5c, 0x00 }, };

const unsigned char OV2640_YUV422[][2] =
{
{ 0xFF, 0x00 },
{ 0x05, 0x00 },
{ 0xDA, 0x10 },
{ 0xD7, 0x03 },
{ 0xDF, 0x00 },
{ 0x33, 0x80 },
{ 0x3C, 0x40 },
{ 0xe1, 0x77 },
{ 0x00, 0x00 }, };

const unsigned char OV2640_JPEG[][2] =
{
{ 0xe0, 0x14 },
{ 0xe1, 0x77 },
{ 0xe5, 0x1f },
{ 0xd7, 0x03 },
{ 0xda, 0x10 },
{ 0xe0, 0x00 },
{ 0xFF, 0x01 },
{ 0x04, 0xF8 }, };

const unsigned char OV2640_1280x960_JPEG[][2] =
{
{ 0xFF, 0x01 },
{ 0x11, 0x01 },
{ 0x12, 0x00 },
{ 0x17, 0x11 },
{ 0x18, 0x75 },
{ 0x32, 0x36 },
{ 0x19, 0x01 },
{ 0x1a, 0x97 },
{ 0x03, 0x0f },
{ 0x37, 0x40 },
{ 0x4f, 0xbb },
{ 0x50, 0x9c },
{ 0x5a, 0x57 },
{ 0x6d, 0x80 },
{ 0x3d, 0x34 },
{ 0x39, 0x02 },
{ 0x35, 0x88 },
{ 0x22, 0x0a },
{ 0x37, 0x40 },
{ 0x34, 0xa0 },
{ 0x06, 0x02 },
{ 0x0d, 0xb7 },
{ 0x0e, 0x01 },
{ 0xFF, 0x00 },
{ 0xe0, 0x04 },
{ 0xc0, 0xc8 },
{ 0xc1, 0x96 },
{ 0x86, 0x3d },
{ 0x50, 0x00 },
{ 0x51, 0x90 },
{ 0x52, 0x2c },
{ 0x53, 0x00 },
{ 0x54, 0x00 },
{ 0x55, 0x88 },
{ 0x57, 0x00 },
{ 0x5a, 0x40 },
{ 0x5b, 0xf0 },
{ 0x5c, 0x01 },
{ 0xd3, 0x02 },
{ 0xe0, 0x00 }, };

uint8_t OV2640_Mem_Write(uint8_t reg, uint8_t camera_tx)
{
	uint8_t camera_rx;
	HAL_I2C_Mem_Write(OV2640_I2C, OV2640_ADDR, reg, I2C_MEMADD_SIZE_8BIT,
			&camera_tx, 1, 100);
	HAL_Delay(10);
	HAL_I2C_Mem_Read(OV2640_I2C, OV2640_ADDR, reg, I2C_MEMADD_SIZE_8BIT,
			&camera_rx, 1, 100);
	if (camera_rx == camera_tx)
	{
		HAL_UART_Transmit(OV2640_DEBUG_UART, (uint8_t*) "I2C write OK.\r\n",
				strlen("I2C write OK.\r\n"), 1000);
		return 0;
	}
	else
	{
		HAL_UART_Transmit(OV2640_DEBUG_UART, (uint8_t*) "I2C write ERROR!\r\n",
				strlen("I2C write ERROR!\r\n"), 1000);
		return 1;
	}
}

uint16_t OV2640_Init_JPEG(void)
{
	uint16_t number_of_errors = 0;
	HAL_UART_Transmit(OV2640_DEBUG_UART, (uint8_t*) "\x1B[2J\x1B[H",
			sizeof("\x1B[2J\x1B[H"), 1000);

	HAL_UART_Transmit(OV2640_DEBUG_UART,
			(uint8_t*) "Executing OV2640_Init_JPEG()\r\n",
			strlen("Executing OV2640_Init_JPEG()\r\n"), 1000);

	HAL_UART_Transmit(OV2640_DEBUG_UART, (uint8_t*) "Resetting OV2640\r\n",
			strlen("Resetting OV2640\r\n"), 1000);

	HAL_GPIO_WritePin(OV2640_PWDN_GPIO_Port, OV2640_PWDN_Pin, GPIO_PIN_RESET); // power ON
	HAL_Delay(5);
	HAL_GPIO_WritePin(OV2640_RST_GPIO_Port, OV2640_RST_Pin, GPIO_PIN_RESET); // hardware reset
	HAL_Delay(5);
	HAL_GPIO_WritePin(OV2640_RST_GPIO_Port, OV2640_RST_Pin, GPIO_PIN_SET);
	HAL_Delay(5);

	// Enter camera configuration mode
	HAL_UART_Transmit(OV2640_DEBUG_UART,
			(uint8_t*) "Entering configuration mode\r\n",
			strlen("Entering configuration mode\r\n"), 1000);
	number_of_errors += OV2640_Mem_Write(OV2640_DSP_RA_DLMT, 0x01);
	HAL_Delay(5);
	number_of_errors += OV2640_Mem_Write(OV2640_SENSOR_COM7, 0x80);
	HAL_Delay(40);

	HAL_UART_Transmit(OV2640_DEBUG_UART, (uint8_t*) "OV2640_JPEG_INIT\r\n",
			strlen("OV2640_JPEG_INIT\r\n"), 1000);

	for (uint16_t i = 0; i < sizeof(OV2640_JPEG_INIT) / 2; i++)
	{
		number_of_errors += OV2640_Mem_Write(OV2640_JPEG_INIT[i][0],
				OV2640_JPEG_INIT[i][1]);
		HAL_Delay(5);
	}

	HAL_UART_Transmit(OV2640_DEBUG_UART, (uint8_t*) "OV2640_YUV422\r\n",
			strlen("OV2640_YUV422\r\n"), 1000);
	for (uint16_t i = 0; i < sizeof(OV2640_YUV422) / 2; i++)
	{
		number_of_errors += OV2640_Mem_Write(OV2640_YUV422[i][0],
				OV2640_YUV422[i][1]);
		HAL_Delay(5);
	}
	HAL_UART_Transmit(OV2640_DEBUG_UART, (uint8_t*) "OV2640_JPEG\r\n",
			strlen("OV2640_JPEG\r\n"), 1000);

	for (uint16_t i = 0; i < sizeof(OV2640_JPEG) / 2; i++)
	{
		number_of_errors += OV2640_Mem_Write(OV2640_JPEG[i][0],
				OV2640_JPEG[i][1]);
		HAL_Delay(5);
	}
	HAL_UART_Transmit(OV2640_DEBUG_UART, (uint8_t*) "OV2640_1280x960_JPEG\r\n",
			strlen("OV2640_1280x960_JPEG\r\n"), 1000);

	for (uint16_t i = 0; i < sizeof(OV2640_1280x960_JPEG) / 2; i++)
	{
		number_of_errors += OV2640_Mem_Write(OV2640_1280x960_JPEG[i][0],
				OV2640_1280x960_JPEG[i][1]);
		HAL_Delay(5);
	}
	HAL_UART_Transmit(OV2640_DEBUG_UART,
			(uint8_t*) "Exiting OV2640_Init_JPEG()\r\n",
			strlen("Exiting OV2640_Init_JPEG()\r\n"), 1000);
	return number_of_errors;

}

uint8_t OV2640_TakePicture(uint32_t *_jpeg_begin, uint32_t *_jpeg_end)
{

	uint32_t timeout = 0;

	uint8_t header_found_flag = 0;
	*_jpeg_begin = 0;
	*_jpeg_end = 0;

	memset(pictureBuff, 0, JPEG_BUFF_SIZE);

	HAL_DCMI_Start_DMA(&hdcmi, DCMI_MODE_SNAPSHOT, (uint32_t) pictureBuff,
	JPEG_BUFF_SIZE / 4);
	while ((hdcmi.Instance->CR & 0x03) == 3)
	{
		if (timeout > 1000) //max timeout: 10 seconds
		{
			HAL_UART_Transmit(OV2640_DEBUG_UART,
					(uint8_t*) "JPEG photo timeout\r\n",
					strlen("JPEG photo timeout\r\n"), 1000);
			return 2;
		}
		HAL_Delay(10);
		timeout++;
	}

	for (int idx = 0; idx < JPEG_BUFF_SIZE; idx++)
	{
		if (header_found_flag == 0 && pictureBuff[idx] == 0xff
				&& pictureBuff[idx + 1] == 0xD8)
		{
			header_found_flag = 1;
			*_jpeg_begin = idx;
		}

		if (header_found_flag == 1 && pictureBuff[idx] == 0xFF
				&& pictureBuff[idx + 1] == 0xD9)
		{
			header_found_flag = 0;
			*_jpeg_end = idx + 1;

			uart_size = sprintf((char*) uart_message,
					"JPEG photo OK. Size: %lu bytes.\r\n",
					*_jpeg_end - *_jpeg_begin + 1);

			HAL_UART_Transmit(OV2640_DEBUG_UART, uart_message, uart_size, 1000);
			return 0;
		}
	}
	return 1;
}
